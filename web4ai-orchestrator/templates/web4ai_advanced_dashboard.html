<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web4AI Advanced Dashboard - Network Orchestrator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary-color: #7c3aed;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --info-color: #06b6d4;
            
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --border-color: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #64748b;
            --border-color: #334155;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        .dashboard-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            grid-template-rows: 70px 1fr;
            grid-template-areas:
                "sidebar header"
                "sidebar main";
            height: 100vh;
            overflow: hidden;
        }

        .header {
            grid-area: header;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            box-shadow: var(--shadow);
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-title {
            font-size: 1.5em;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            background: var(--bg-secondary);
            font-size: 0.9em;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success-color);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .control-btn {
            background: none;
            border: none;
            font-size: 1.3em;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .control-btn:hover {
            background: var(--bg-secondary);
            color: var(--primary-color);
        }

        .sidebar {
            grid-area: sidebar;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar-section {
            margin-bottom: 30px;
        }

        .sidebar-title {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .main-content {
            grid-area: main;
            padding: 30px;
            overflow-y: auto;
            background: var(--bg-primary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .stat-change {
            font-size: 0.8em;
            font-weight: 500;
        }

        .stat-change.positive {
            color: var(--success-color);
        }

        .stat-change.negative {
            color: var(--error-color);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .network-topology-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
        }

        .section-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .network-topology {
            width: 100%;
            height: 400px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-primary);
            position: relative;
            overflow: hidden;
        }

        .agents-list {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
        }

        .agent-item {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }

        .agent-item:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow);
        }

        .agent-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 8px;
        }

        .agent-name {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 1.1em;
        }

        .agent-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
        }

        .agent-status.online {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }

        .agent-status.offline {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error-color);
        }

        .agent-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .agent-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .agent-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .agent-btn.primary {
            background: var(--primary-color);
            color: white;
        }

        .agent-btn.secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .agent-btn:hover {
            transform: translateY(-1px);
            opacity: 0.9;
        }

        .operations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .operation-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
        }

        .operation-title {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .node-tooltip {
            position: absolute;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            font-size: 0.9em;
            box-shadow: var(--shadow-lg);
            pointer-events: none;
            z-index: 1000;
            max-width: 250px;
        }

        .connection-line {
            stroke: var(--primary-color);
            stroke-width: 2;
            opacity: 0.6;
        }

        .node-circle {
            fill: var(--primary-color);
            stroke: var(--bg-primary);
            stroke-width: 3;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .node-circle:hover {
            fill: var(--secondary-color);
            r: 12;
        }

        .node-label {
            font-size: 12px;
            font-weight: 500;
            fill: var(--text-primary);
            text-anchor: middle;
            pointer-events: none;
        }

        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .dashboard-container {
                grid-template-columns: 1fr;
                grid-template-areas:
                    "header"
                    "main";
            }
            
            .sidebar {
                display: none;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <div class="header-left">
                <h1 class="header-title">Web4AI Network</h1>
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span id="connectionStatus">Connected</span>
                </div>
            </div>
            <div class="header-controls">
                <button class="control-btn" onclick="refreshData()" title="Refresh">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button class="control-btn" onclick="toggleTheme()" title="Toggle Theme">
                    <i class="fas fa-moon"></i>
                </button>
                <button class="control-btn" onclick="showSettings()" title="Settings">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>

        <div class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">
                    <i class="fas fa-network-wired"></i>
                    Network Overview
                </div>
                <div id="networkStats"></div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">
                    <i class="fas fa-server"></i>
                    Active Nodes
                </div>
                <div id="nodesList"></div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">
                    <i class="fas fa-chart-line"></i>
                    Performance
                </div>
                <div id="performanceMetrics"></div>
            </div>
        </div>

        <div class="main-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalAgents">0</div>
                    <div class="stat-label">Total Agents</div>
                    <div class="stat-change positive" id="agentsChange">+0 today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activeNodes">0</div>
                    <div class="stat-label">Active Nodes</div>
                    <div class="stat-change positive" id="nodesChange">+0 online</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalInferences">0</div>
                    <div class="stat-label">AI Inferences</div>
                    <div class="stat-change positive" id="inferencesChange">+0 today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="networkHealth">100%</div>
                    <div class="stat-label">Network Health</div>
                    <div class="stat-change positive" id="healthChange">Optimal</div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="network-topology-section">
                    <div class="section-title">
                        <i class="fas fa-project-diagram"></i>
                        Network Topology
                        <div style="margin-left: auto; display: flex; gap: 10px;">
                            <button class="control-btn" onclick="centerNetwork()" title="Center View">
                                <i class="fas fa-crosshairs"></i>
                            </button>
                            <button class="control-btn" onclick="resetZoom()" title="Reset Zoom">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                    </div>
                    <div class="network-topology" id="networkTopology"></div>
                </div>

                <div class="agents-list">
                    <div class="section-title">
                        <i class="fas fa-robot"></i>
                        Agent Details
                        <span id="agentCount" style="margin-left: auto; font-size: 0.9em; color: var(--text-secondary);">0 agents</span>
                    </div>
                    <div id="agentsList" style="max-height: 400px; overflow-y: auto;"></div>
                </div>
            </div>

            <div class="operations-grid">
                <div class="operation-card">
                    <div class="operation-title">AI Operations</div>
                    <div id="aiOperations"></div>
                </div>
                <div class="operation-card">
                    <div class="operation-title">Blockchain Status</div>
                    <div id="blockchainStatus"></div>
                </div>
                <div class="operation-card">
                    <div class="operation-title">System Metrics</div>
                    <div id="systemMetrics"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let networkData = { nodes: [], agents: [] };
        let svg, simulation;
        let socket;
        let isOfflineMode = false;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeWebSocket();
            initializeNetworkTopology();
            loadDashboardData();
            
            // Auto-refresh every 30 seconds
            setInterval(loadDashboardData, 30000);
        });

        // Helper functions for connection status and error handling
        function updateConnectionStatus(status, type) {
            const statusElement = document.getElementById('connectionStatus');
            const statusDot = statusElement.parentElement.querySelector('.status-dot');
            
            statusElement.textContent = status;
            
            // Update status dot color based on type
            if (type === 'success') {
                statusDot.style.background = 'var(--success-color)';
            } else if (type === 'error') {
                statusDot.style.background = 'var(--error-color)';
            } else {
                statusDot.style.background = 'var(--warning-color)';
            }
        }

        function showConnectionError(message) {
            let errorContainer = document.getElementById('connectionError');
            if (!errorContainer) {
                errorContainer = document.createElement('div');
                errorContainer.id = 'connectionError';
                errorContainer.style.cssText = `
                    position: fixed;
                    top: 80px;
                    left: 20px;
                    right: 20px;
                    background: var(--error-color);
                    color: white;
                    padding: 15px 20px;
                    border-radius: 8px;
                    box-shadow: var(--shadow-lg);
                    z-index: 1000;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                `;
                document.body.appendChild(errorContainer);
            }
            
            errorContainer.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                <div style="flex: 1;">
                    <strong>Connection Error:</strong> ${message}
                </div>
                <button onclick="hideConnectionError()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            isOfflineMode = true;
        }

        function hideConnectionError() {
            const errorContainer = document.getElementById('connectionError');
            if (errorContainer) {
                errorContainer.remove();
            }
            isOfflineMode = false;
        }

        function showLoadingState() {
            const statsCards = document.querySelectorAll('.stat-value');
            statsCards.forEach(card => {
                if (!card.querySelector('.loading')) {
                    card.innerHTML = '<div class="loading"></div>';
                }
            });
        }

        function hideLoadingState() {
            // Loading state will be replaced by actual data
        }

        function initializeWebSocket() {
            try {
                // Try to connect with error handling
                socket = io({
                    timeout: 5000,
                    autoConnect: true,
                    reconnection: true,
                    reconnectionAttempts: 3,
                    reconnectionDelay: 2000
                });
                
                socket.on('connect', function() {
                    console.log('Connected to server');
                    updateConnectionStatus('Connected', 'success');
                    hideConnectionError();
                });

                socket.on('disconnect', function() {
                    console.log('Disconnected from server');
                    updateConnectionStatus('Disconnected', 'error');
                });

                socket.on('connect_error', function(error) {
                    console.error('Connection error:', error);
                    updateConnectionStatus('Connection Failed', 'error');
                    showConnectionError('WebSocket connection failed. Server may be down or misconfigured.');
                });

                socket.on('agent_update', function(data) {
                    updateAgentInList(data);
                });

                socket.on('network_update', function(data) {
                    updateNetworkTopology(data);
                });
            } catch (error) {
                console.error('WebSocket initialization error:', error);
                updateConnectionStatus('WebSocket Error', 'error');
                showConnectionError('WebSocket not available. Running in offline mode.');
            }
        }

        function initializeNetworkTopology() {
            const container = document.getElementById('networkTopology');
            const width = container.clientWidth;
            const height = container.clientHeight;

            svg = d3.select('#networkTopology')
                .append('svg')
                .attr('width', width)
                .attr('height', height)
                .style('background', 'var(--bg-primary)');

            // Add zoom behavior
            const zoom = d3.zoom()
                .scaleExtent([0.1, 4])
                .on('zoom', function(event) {
                    svg.select('.network-group').attr('transform', event.transform);
                });

            svg.call(zoom);

            // Create main group for network elements
            svg.append('g').attr('class', 'network-group');

            // Initialize force simulation
            simulation = d3.forceSimulation()
                .force('link', d3.forceLink().id(d => d.id).distance(100))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(30));
        }

        async function loadDashboardData() {
            showLoadingState();
            
            try {
                // Try to load data from the server API
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
                
                const response = await fetch('/api/v3/dashboard', {
                    signal: controller.signal,
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    hideLoadingState();
                    hideConnectionError();
                    updateStats(data);
                    updateAgentsList(data.agents || []);
                    updateNetworkData(data);
                    updateOperations(data);
                    updateConnectionStatus('API Connected', 'success');
                } else {
                    throw new Error(data.error || 'API returned unsuccessful response');
                }
                
            } catch (error) {
                hideLoadingState();
                console.error('Error loading dashboard data:', error);
                
                let errorMessage = 'Failed to connect to server API';
                if (error.name === 'AbortError') {
                    errorMessage = 'API request timeout - server may be overloaded';
                } else if (error.message.includes('500')) {
                    errorMessage = 'Server internal error - check server logs';
                } else if (error.message.includes('fetch')) {
                    errorMessage = 'Network error - server may be down';
                }
                
                showConnectionError(errorMessage + '. Using demo data.');
                updateConnectionStatus('API Error', 'error');
                
                // Load demo data as fallback
                loadDemoData();
            }
        }

        function updateStats(data) {
            const stats = data.stats || {};
            const agents = data.agents || [];
            
            document.getElementById('totalAgents').textContent = agents.length;
            document.getElementById('activeNodes').textContent = stats.active_nodes || agents.filter(a => a.status === 'online').length;
            document.getElementById('totalInferences').textContent = stats.total_inferences || 0;
            
            // Network health with offline mode indicator
            const healthElement = document.getElementById('networkHealth');
            const healthValue = Math.round((stats.network_health || (isOfflineMode ? 0.3 : 1)) * 100);
            healthElement.innerHTML = `${healthValue}%${isOfflineMode ? '<span class="demo-mode-badge">DEMO</span>' : ''}`;
            
            // Update change indicators
            document.getElementById('agentsChange').textContent = `+${stats.agents_today || 0} today`;
            document.getElementById('nodesChange').textContent = `${stats.nodes_online || stats.active_nodes || 0} online`;
            document.getElementById('inferencesChange').textContent = `+${stats.inferences_today || 0} today`;
            
            const healthChange = document.getElementById('healthChange');
            if (isOfflineMode) {
                healthChange.textContent = 'Offline Mode';
                healthChange.className = 'stat-change negative';
            } else {
                healthChange.textContent = stats.network_health >= 0.9 ? 'Optimal' : 'Good';
                healthChange.className = 'stat-change positive';
            }
        }

        function updateAgentsList(agents) {
            const agentsList = document.getElementById('agentsList');
            const agentCount = document.getElementById('agentCount');
            
            agentCount.textContent = `${agents.length} agents`;
            
            if (agents.length === 0) {
                if (isOfflineMode) {
                    agentsList.innerHTML = `
                        <div style="text-align: center; color: var(--text-muted); padding: 20px;">
                            <i class="fas fa-wifi" style="font-size: 2em; margin-bottom: 10px; color: var(--error-color);"></i>
                            <div>No agents available - Server offline</div>
                            <div style="font-size: 0.9em; margin-top: 10px;">
                                <button onclick="runServerDiagnostics()" style="background: var(--info-color); color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer;">
                                    <i class="fas fa-stethoscope"></i> Run Diagnostics
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    agentsList.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 20px;">No agents registered</div>';
                }
                return;
            }

            agentsList.innerHTML = agents.map(agent => {
                const capabilities = agent.capabilities || [];
                const apiUrls = agent.api_urls || {};
                
                return `
                    <div class="agent-item">
                        <div class="agent-header">
                            <div class="agent-name">${agent.agent_id || agent.name || 'Unknown Agent'}</div>
                            <div class="agent-status ${agent.status || 'offline'}">${(agent.status || 'offline').toUpperCase()}</div>
                        </div>
                        <div class="agent-details">
                            <div><i class="fas fa-server"></i> Host: ${agent.host || 'localhost'}:${agent.port || '8080'}</div>
                            <div><i class="fas fa-clock"></i> Uptime: ${formatUptime(agent.uptime || 0)}</div>
                            <div><i class="fas fa-microchip"></i> CPU: ${Math.round((agent.cpu_usage || 0) * 100)}%</div>
                            <div><i class="fas fa-memory"></i> RAM: ${Math.round((agent.memory_usage || 0) * 100)}%</div>
                        </div>
                        <div style="margin: 8px 0; font-size: 0.85em; color: var(--text-secondary);">
                            <strong>Capabilities:</strong> ${capabilities.slice(0, 3).join(', ')}${capabilities.length > 3 ? '...' : ''}
                        </div>
                        <div class="agent-actions">
                            <button class="agent-btn primary" onclick="openAgentDashboard('${apiUrls.dashboard || `http://${agent.host}:${agent.port}`}')">
                                <i class="fas fa-external-link-alt"></i> Dashboard
                            </button>
                            <button class="agent-btn secondary" onclick="showAgentDetails('${agent.agent_id}')">
                                <i class="fas fa-info-circle"></i> Details
                            </button>
                            <button class="agent-btn secondary" onclick="restartAgent('${agent.agent_id}')">
                                <i class="fas fa-sync-alt"></i> Restart
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateNetworkData(data) {
            const agents = data.agents || [];
            
            // Create nodes for visualization
            const nodes = agents.map((agent, index) => ({
                id: agent.agent_id || `agent_${index}`,
                name: agent.agent_id || `Agent ${index + 1}`,
                type: 'agent',
                status: agent.status || 'offline',
                host: agent.host || 'localhost',
                port: agent.port || 8080,
                capabilities: agent.capabilities || [],
                cpu_usage: agent.cpu_usage || 0,
                memory_usage: agent.memory_usage || 0
            }));

            // Add orchestrator node
            nodes.unshift({
                id: 'orchestrator',
                name: 'Web4AI Orchestrator',
                type: 'orchestrator',
                status: 'online',
                host: 'localhost',
                port: 9000
            });

            // Create links between orchestrator and agents
            const links = agents.map((agent, index) => ({
                source: 'orchestrator',
                target: agent.agent_id || `agent_${index}`
            }));

            updateNetworkVisualization({ nodes, links });
        }

        function updateNetworkVisualization(graphData) {
            const networkGroup = svg.select('.network-group');
            
            // Update links
            const link = networkGroup.selectAll('.connection-line')
                .data(graphData.links);

            link.enter()
                .append('line')
                .attr('class', 'connection-line')
                .merge(link);

            link.exit().remove();

            // Update nodes
            const node = networkGroup.selectAll('.node-group')
                .data(graphData.nodes);

            const nodeEnter = node.enter()
                .append('g')
                .attr('class', 'node-group')
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));

            // Add circles for nodes
            nodeEnter.append('circle')
                .attr('class', 'node-circle')
                .attr('r', d => d.type === 'orchestrator' ? 15 : 10)
                .style('fill', d => {
                    if (d.type === 'orchestrator') return 'var(--secondary-color)';
                    return d.status === 'online' ? 'var(--success-color)' : 'var(--error-color)';
                });

            // Add labels
            nodeEnter.append('text')
                .attr('class', 'node-label')
                .attr('dy', d => d.type === 'orchestrator' ? 25 : 20)
                .text(d => d.name);

            // Add tooltips
            nodeEnter.on('mouseover', showNodeTooltip)
                .on('mouseout', hideNodeTooltip);

            node.exit().remove();

            // Update simulation
            simulation.nodes(graphData.nodes);
            simulation.force('link').links(graphData.links);
            simulation.alpha(1).restart();

            simulation.on('tick', () => {
                networkGroup.selectAll('.connection-line')
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                networkGroup.selectAll('.node-group')
                    .attr('transform', d => `translate(${d.x},${d.y})`);
            });
        }

        function updateOperations(data) {
            // AI Operations
            const aiOps = document.getElementById('aiOperations');
            const models = data.ai_summary?.active_models || ['GPT-4', 'BERT', 'Transformer'];
            aiOps.innerHTML = models.map(model => 
                `<div style="margin: 8px 0; padding: 8px; background: var(--bg-primary); border-radius: 6px;">
                    <strong>${model}</strong> - Active
                </div>`
            ).join('');

            // Blockchain Status
            const blockchain = document.getElementById('blockchainStatus');
            const wallets = data.blockchain_summary?.wallets || [];
            if (wallets.length > 0) {
                blockchain.innerHTML = wallets.map(wallet => 
                    `<div style="margin: 8px 0; padding: 8px; background: var(--bg-primary); border-radius: 6px;">
                        <strong>${wallet.currency}</strong>: ${wallet.balance}
                    </div>`
                ).join('');
            } else {
                blockchain.innerHTML = '<div style="color: var(--text-muted);">No wallet data available</div>';
            }

            // System Metrics
            const metrics = document.getElementById('systemMetrics');
            const stats = data.stats || {};
            metrics.innerHTML = `
                <div style="margin: 8px 0; display: flex; justify-content: space-between;">
                    <span>CPU Usage:</span> <span>${Math.round((stats.cpu_usage || 0) * 100)}%</span>
                </div>
                <div style="margin: 8px 0; display: flex; justify-content: space-between;">
                    <span>Memory:</span> <span>${Math.round((stats.memory_usage || 0) * 100)}%</span>
                </div>
                <div style="margin: 8px 0; display: flex; justify-content: space-between;">
                    <span>Uptime:</span> <span>${formatUptime(stats.uptime || 0)}</span>
                </div>
            `;
        }

        // Utility functions
        function formatUptime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return `${hours}h ${minutes}m`;
        }

        function showNodeTooltip(event, d) {
            const tooltip = d3.select('body').append('div')
                .attr('class', 'node-tooltip')
                .style('opacity', 0);

            tooltip.html(`
                <strong>${d.name}</strong><br/>
                Type: ${d.type}<br/>
                Status: ${d.status}<br/>
                Host: ${d.host}:${d.port}<br/>
                ${d.cpu_usage ? `CPU: ${Math.round(d.cpu_usage * 100)}%<br/>` : ''}
                ${d.memory_usage ? `Memory: ${Math.round(d.memory_usage * 100)}%<br/>` : ''}
                ${d.capabilities ? `Capabilities: ${d.capabilities.slice(0, 2).join(', ')}` : ''}
            `)
                .style('left', (event.pageX + 10) + 'px')
                .style('top', (event.pageY - 10) + 'px')
                .transition()
                .duration(200)
                .style('opacity', 1);
        }

        function hideNodeTooltip() {
            d3.selectAll('.node-tooltip').remove();
        }

        // Drag functions for network nodes
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        // Control functions
        function refreshData() {
            loadDashboardData();
        }

        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            body.setAttribute('data-theme', currentTheme === 'dark' ? 'light' : 'dark');
        }

        function centerNetwork() {
            const container = document.getElementById('networkTopology');
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            svg.transition()
                .duration(750)
                .call(d3.zoom().transform, d3.zoomIdentity.translate(0, 0).scale(1));
        }

        function resetZoom() {
            svg.transition()
                .duration(750)
                .call(d3.zoom().transform, d3.zoomIdentity);
        }

        function openAgentDashboard(url) {
            window.open(url, '_blank');
        }

        function showAgentDetails(agentId) {
            alert(`Showing details for agent: ${agentId}`);
            // Implement detailed view modal
        }

        function restartAgent(agentId) {
            if (confirm(`Are you sure you want to restart agent: ${agentId}?`)) {
                // Implement restart functionality
                fetch(`/api/v5/remote/agents/${agentId}/restart`, { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        alert(data.success ? 'Agent restart initiated' : 'Failed to restart agent');
                    })
                    .catch(error => {
                        console.error('Error restarting agent:', error);
                        alert('Error restarting agent');
                    });
            }
        }

        function showSettings() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 2000;
            `;
            
            modal.innerHTML = `
                <div style="background: var(--bg-primary); padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <h2 style="margin-bottom: 20px; color: var(--text-primary);">
                        <i class="fas fa-cog"></i> Dashboard Settings
                    </h2>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--text-secondary); margin-bottom: 10px;">Connection Status</h3>
                        <div style="padding: 10px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 10px;">
                            <strong>Current Status:</strong> ${isOfflineMode ? 'Offline Mode' : 'Connected'}<br>
                            <strong>WebSocket:</strong> ${socket && socket.connected ? 'Connected' : 'Disconnected'}<br>
                            <strong>API:</strong> ${isOfflineMode ? 'Unavailable' : 'Available'}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--text-secondary); margin-bottom: 10px;">Troubleshooting</h3>
                        <button onclick="runServerDiagnostics(); closeModal()" 
                                style="background: var(--info-color); color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; margin-right: 10px;">
                            <i class="fas fa-stethoscope"></i> Run Diagnostics
                        </button>
                        <button onclick="loadDashboardData(); closeModal()" 
                                style="background: var(--primary-color); color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; margin-right: 10px;">
                            <i class="fas fa-sync-alt"></i> Retry Connection
                        </button>
                        <button onclick="showTroubleshootingInfo(); closeModal()" 
                                style="background: var(--warning-color); color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer;">
                            <i class="fas fa-question-circle"></i> Help
                        </button>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--text-secondary); margin-bottom: 10px;">Dashboard Options</h3>
                        <label style="display: block; margin-bottom: 10px;">
                            <input type="checkbox" id="autoRefresh" checked> Auto-refresh every 30 seconds
                        </label>
                        <label style="display: block; margin-bottom: 10px;">
                            <input type="checkbox" id="showOfflineAgents" checked> Show offline agents
                        </label>
                        <label style="display: block; margin-bottom: 10px;">
                            <input type="checkbox" id="enableNotifications"> Enable notifications
                        </label>
                    </div>
                    
                    <div style="text-align: right;">
                        <button onclick="closeModal()" 
                                style="background: var(--text-secondary); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            modal.onclick = (e) => {
                if (e.target === modal) closeModal();
            };
            
            window.closeModal = () => modal.remove();
            document.body.appendChild(modal);
        }

        function showDiagnosticsModal(diagnostics) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 2000;
            `;
            
            const testResults = diagnostics.tests.map(test => 
                `<div style="margin: 10px 0; padding: 10px; background: var(--bg-secondary); border-radius: 6px;">
                    <strong>${test.test}:</strong> 
                    <span style="color: ${test.status === 'PASS' ? 'var(--success-color)' : 'var(--error-color)'}">
                        ${test.status}
                    </span><br>
                    <small style="color: var(--text-secondary);">${test.details}</small>
                </div>`
            ).join('');
            
            modal.innerHTML = `
                <div style="background: var(--bg-primary); padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <h2 style="margin-bottom: 20px; color: var(--text-primary);">
                        <i class="fas fa-stethoscope"></i> Server Diagnostics
                    </h2>
                    
                    <div style="margin-bottom: 20px;">
                        <strong>Timestamp:</strong> ${diagnostics.timestamp}
                    </div>
                    
                    ${testResults}
                    
                    <div style="margin-top: 20px; padding: 15px; background: var(--bg-secondary); border-radius: 8px;">
                        <h3 style="margin-bottom: 10px;">Common Solutions:</h3>
                        <ul style="margin: 0; padding-left: 20px; color: var(--text-secondary);">
                            <li>Check if the server is running on the correct port</li>
                            <li>Verify Flask-SocketIO is installed: <code>pip install Flask-SocketIO</code></li>
                            <li>Check server logs for import errors or configuration issues</li>
                            <li>Ensure all required dependencies are installed</li>
                            <li>Try restarting the server: <code>python main.py</code></li>
                        </ul>
                    </div>
                    
                    <div style="text-align: right; margin-top: 20px;">
                        <button onclick="closeModal()" 
                                style="background: var(--primary-color); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            modal.onclick = (e) => {
                if (e.target === modal) closeModal();
            };
            
            window.closeModal = () => modal.remove();
            document.body.appendChild(modal);
        }

        function showTroubleshootingInfo() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 2000;
            `;
            
            modal.innerHTML = `
                <div style="background: var(--bg-primary); padding: 30px; border-radius: 12px; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <h2 style="margin-bottom: 20px; color: var(--text-primary);">
                        <i class="fas fa-question-circle"></i> Troubleshooting Guide
                    </h2>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--error-color);">ðŸ”¥ Server 500 Errors</h3>
                        <p>If you're seeing 500 Internal Server Errors:</p>
                        <ol style="margin-left: 20px; color: var(--text-secondary);">
                            <li>Check server console for error messages</li>
                            <li>Verify all dependencies: <code>pip install -r requirements.txt</code></li>
                            <li>Check for import errors in server modules</li>
                            <li>Ensure database is accessible and properly initialized</li>
                            <li>Try running: <code>python setup_and_run.py</code></li>
                        </ol>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--warning-color);">ðŸ”Œ WebSocket Connection Issues</h3>
                        <p>For WebSocket connection problems:</p>
                        <ol style="margin-left: 20px; color: var(--text-secondary);">
                            <li>Install Flask-SocketIO: <code>pip install Flask-SocketIO</code></li>
                            <li>Check if server is running on correct port (usually 5000 or 9000)</li>
                            <li>Verify CORS settings in server configuration</li>
                            <li>Check browser developer tools for specific error messages</li>
                        </ol>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--info-color);">ðŸš€ Quick Start Commands</h3>
                        <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; font-family: monospace;">
                            # Enhanced Node Server<br>
                            cd enhanced_node<br>
                            python setup_and_run.py<br><br>
                            
                            # Or manually:<br>
                            pip install -r requirements.txt<br>
                            python main.py<br><br>
                            
                            # Check logs:<br>
                            tail -f logs/enhanced_node_server.log
                        </div>
                    </div>
                    
                    <div style="text-align: right;">
                        <button onclick="closeModal()" 
                                style="background: var(--primary-color); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            modal.onclick = (e) => {
                if (e.target === modal) closeModal();
            };
            
            window.closeModal = () => modal.remove();
            document.body.appendChild(modal);
        }

        // Demo data for when API is not available
        function loadDemoData() {
            console.log('Loading demo data due to API unavailability');
            
            const demoData = {
                success: true,
                agents: [
                    {
                        agent_id: 'ultimate_agent_1',
                        host: 'localhost',
                        port: 8080,
                        status: 'online',
                        uptime: 3600,
                        cpu_usage: 0.45,
                        memory_usage: 0.62,
                        capabilities: ['ai_inference', 'blockchain_ops', 'task_control'],
                        api_urls: {
                            dashboard: 'http://localhost:8080'
                        }
                    },
                    {
                        agent_id: 'enhanced_node_1',
                        host: 'localhost',
                        port: 5000,
                        status: 'offline',
                        uptime: 7200,
                        cpu_usage: 0.23,
                        memory_usage: 0.34,
                        capabilities: ['agent_management', 'monitoring', 'websocket'],
                        api_urls: {
                            dashboard: 'http://localhost:5000'
                        }
                    },
                    {
                        agent_id: 'demo_agent_offline',
                        host: 'demo.local',
                        port: 9000,
                        status: 'offline',
                        uptime: 0,
                        cpu_usage: 0,
                        memory_usage: 0,
                        capabilities: ['demo'],
                        api_urls: {
                            dashboard: 'http://demo.local:9000'
                        }
                    }
                ],
                stats: {
                    active_nodes: 1,
                    total_inferences: 1247,
                    network_health: 0.65, // Lower due to offline mode
                    cpu_usage: 0.34,
                    memory_usage: 0.48,
                    uptime: 86400,
                    agents_today: 3,
                    nodes_online: 1,
                    inferences_today: 124
                },
                ai_summary: {
                    active_models: ['Demo GPT-4', 'Demo BERT', 'Demo Transformer']
                },
                blockchain_summary: {
                    wallets: [
                        { currency: 'ETH', balance: '0.00 (Demo)', value: '$0' },
                        { currency: 'PAIN', balance: '100.00 (Demo)', value: '$50' }
                    ]
                }
            };
            
            updateStats(demoData);
            updateAgentsList(demoData.agents);
            updateNetworkData(demoData);
            updateOperations(demoData);
            
            // Add demo mode indicator
            addDemoModeIndicator();
        }

        function addDemoModeIndicator() {
            let demoIndicator = document.getElementById('demoIndicator');
            if (!demoIndicator) {
                demoIndicator = document.createElement('div');
                demoIndicator.id = 'demoIndicator';
                demoIndicator.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    background: var(--warning-color);
                    color: white;
                    padding: 10px 15px;
                    border-radius: 8px;
                    font-size: 0.9em;
                    box-shadow: var(--shadow);
                    z-index: 1000;
                `;
                demoIndicator.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Demo Mode</strong> - Server offline
                `;
                document.body.appendChild(demoIndicator);
            }
        }

        // Server diagnostics
        function runServerDiagnostics() {
            console.log('Running server diagnostics...');
            
            const diagnostics = {
                timestamp: new Date().toISOString(),
                tests: []
            };

            // Test basic connectivity
            fetch('/api/v3/dashboard', { method: 'HEAD' })
                .then(response => {
                    diagnostics.tests.push({
                        test: 'API Connectivity',
                        status: response.ok ? 'PASS' : 'FAIL',
                        details: `HTTP ${response.status}: ${response.statusText}`
                    });
                })
                .catch(error => {
                    diagnostics.tests.push({
                        test: 'API Connectivity', 
                        status: 'FAIL',
                        details: error.message
                    });
                });

            // Test WebSocket
            const wsTest = io({ autoConnect: false, timeout: 3000 });
            wsTest.on('connect', () => {
                diagnostics.tests.push({
                    test: 'WebSocket Connectivity',
                    status: 'PASS',
                    details: 'WebSocket connection successful'
                });
                wsTest.disconnect();
            });
            
            wsTest.on('connect_error', (error) => {
                diagnostics.tests.push({
                    test: 'WebSocket Connectivity',
                    status: 'FAIL', 
                    details: error.message
                });
            });
            
            wsTest.connect();
            
            setTimeout(() => {
                console.log('Diagnostics Results:', diagnostics);
                showDiagnosticsModal(diagnostics);
            }, 5000);
        }

        // Handle window resize
        window.addEventListener('resize', function() {
            const container = document.getElementById('networkTopology');
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            svg.attr('width', width).attr('height', height);
            simulation.force('center', d3.forceCenter(width / 2, height / 2));
            simulation.alpha(1).restart();
        });
    </script>
</body>
</html>